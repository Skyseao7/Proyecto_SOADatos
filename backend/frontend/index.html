<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Sistema SOA - Monitoreo Nacional</title>
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.7.1/dist/leaflet.css" />
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://unpkg.com/leaflet@1.7.1/dist/leaflet.js"></script>
    <style>
        body { font-family: 'Segoe UI', sans-serif; background: #f4f7f6; margin: 0; padding: 0; }
        header { background: #2c3e50; color: white; padding: 15px 30px; display: flex; justify-content: space-between; align-items: center; box-shadow: 0 2px 10px rgba(0,0,0,0.2); }
        .container { display: grid; grid-template-columns: 320px 1fr; gap: 25px; padding: 25px; height: 90vh; }
        
        /* Estilos de la Barra Lateral */
        .sidebar { background: white; padding: 25px; border-radius: 12px; box-shadow: 0 4px 15px rgba(0,0,0,0.05); display: flex; flex-direction: column; gap: 15px; }
        .sidebar h3 { margin-top: 0; color: #2c3e50; border-bottom: 2px solid #eee; padding-bottom: 10px; }
        
        label { font-size: 0.85rem; font-weight: bold; color: #7f8c8d; margin-bottom: -10px; }
        select { width: 100%; padding: 12px; border-radius: 6px; border: 1px solid #ddd; background: #f9f9f9; font-size: 0.95rem; transition: all 0.3s; }
        select:focus { border-color: #3498db; outline: none; box-shadow: 0 0 0 3px rgba(52,152,219,0.1); }
        select:disabled { background: #eee; color: #aaa; cursor: not-allowed; }

        #map { width: 100%; height: 300px; border-radius: 8px; margin-top: 10px; border: 1px solid #eee; }

        /* Estilos del Dashboard Principal */
        .main { display: grid; grid-template-rows: auto 1fr 1fr; gap: 20px; overflow-y: auto; }
        
        .kpis { display: grid; grid-template-columns: repeat(4, 1fr); gap: 20px; }
        .kpi-card { background: white; padding: 20px; border-radius: 12px; text-align: center; box-shadow: 0 4px 15px rgba(0,0,0,0.05); transition: transform 0.2s; }
        .kpi-card:hover { transform: translateY(-5px); }
        .kpi-card h3 { margin: 0; font-size: 0.85rem; color: #95a5a6; text-transform: uppercase; letter-spacing: 1px; }
        .kpi-card p { margin: 10px 0 0; font-size: 1.8rem; font-weight: 800; color: #2c3e50; }

        .charts-area { display: grid; grid-template-columns: 1fr 1fr; gap: 20px; }
        .chart-box { background: white; padding: 20px; border-radius: 12px; box-shadow: 0 4px 15px rgba(0,0,0,0.05); position: relative; height: 320px; }
    </style>
</head>
<body>
    <header>
        <div>
            <h2 style="margin:0;">SOA MONITOR - PER칔</h2>
            <small style="opacity: 0.8;">Plataforma de Inteligencia Territorial</small>
        </div>
        <div style="font-size: 0.9rem;">游릭 Sistema Online</div>
    </header>

    <div class="container">
        <div class="sidebar">
            <h3>Filtros Territoriales</h3>
            
            <label>1. Regi칩n</label>
            <select id="selRegion" onchange="filtrarProvincias()">
                <option value="">-- Seleccione --</option>
            </select>

            <label>2. Provincia</label>
            <select id="selProvincia" onchange="filtrarDistritos()" disabled>
                <option value="">-- Seleccione --</option>
            </select>

            <label>3. Distrito</label>
            <select id="selDistrito" onchange="cargarDashboard()" disabled>
                <option value="">-- Seleccione --</option>
            </select>

            <div id="map"></div>
            
            <div style="margin-top:auto; padding-top:20px; border-top:1px solid #eee; font-size:0.8rem; color:#7f8c8d;">
                <p><strong>Backend:</strong> Python FastAPI</p>
                <p><strong>DB:</strong> Supabase (PostgreSQL)</p>
                <p><strong>Clima:</strong> Open-Meteo Real-Time</p>
            </div>
        </div>

        <div class="main">
            <div class="kpis">
                <div class="kpi-card"><h3>Temperatura</h3><p id="kpiTemp">--춿C</p></div>
                <div class="kpi-card"><h3>Viento</h3><p id="kpiViento">-- km/h</p></div>
                <div class="kpi-card"><h3>Poblaci칩n</h3><p id="kpiPob">--</p></div>
                <div class="kpi-card"><h3>PBI (Crecimiento)</h3><p id="kpiPbi" style="color:#27ae60;">--%</p></div>
            </div>

            <div class="charts-area">
                <div class="chart-box"><canvas id="chartClima"></canvas></div>
                <div class="chart-box"><canvas id="chartRadar"></canvas></div>
            </div>

            <div class="chart-box" style="height: 250px;"><canvas id="chartMix"></canvas></div>
        </div>
    </div>

    <script>
        // 1. CONFIGURACI칍N INICIAL
        const API_URL = "http://127.0.0.1:8000";
        let todosLosLugares = []; 
        
        let map = L.map('map').setView([-9.19, -75.01], 5); 
        L.tileLayer('https://{s}.basemaps.cartocdn.com/light_all/{z}/{x}/{y}{r}.png').addTo(map);
        let marker;

        let gClima, gRadar, gMix;

        // 2. CARGAR DATOS MAESTROS
        async function iniciarSistema() {
            try {
                const resp = await fetch(`${API_URL}/api/lugares`);
                todosLosLugares = await resp.json();
                
                console.log("Base de datos descargada:", todosLosLugares);

                // A. Obtener regiones 칰nicas
                let regionesUnicas = [...new Set(todosLosLugares.map(item => item.region))];
                
                // B. ORDENAR ALFAB칄TICAMENTE (A-Z)
                regionesUnicas.sort((a, b) => a.localeCompare(b));

                // C. Llenar el select
                const selRegion = document.getElementById('selRegion');
                regionesUnicas.forEach(reg => {
                    const opt = document.createElement('option');
                    opt.value = reg;
                    opt.innerText = reg;
                    selRegion.appendChild(opt);
                });

            } catch (error) {
                console.error(error);
                alert("Error conectando con el servidor.");
            }
        }

        // 3. L칍GICA DE FILTROS EN CASCADA (ORDENADA)
        function filtrarProvincias() {
            const regionSel = document.getElementById('selRegion').value;
            const selProv = document.getElementById('selProvincia');
            const selDist = document.getElementById('selDistrito');

            // Resetear selects hijos
            selProv.innerHTML = '<option value="">-- Seleccione --</option>';
            selDist.innerHTML = '<option value="">-- Seleccione --</option>';
            selDist.disabled = true;

            if (!regionSel) {
                selProv.disabled = true;
                return;
            }

            // A. Filtrar provincias de esa regi칩n
            const provincias = todosLosLugares.filter(l => l.region === regionSel);
            let provUnicas = [...new Set(provincias.map(p => p.provincia))];

            // B. ORDENAR ALFAB칄TICAMENTE
            provUnicas.sort((a, b) => a.localeCompare(b));

            // C. Llenar select
            provUnicas.forEach(p => {
                const opt = document.createElement('option');
                opt.value = p;
                opt.innerText = p;
                selProv.appendChild(opt);
            });

            selProv.disabled = false;
        }

        function filtrarDistritos() {
            const regionSel = document.getElementById('selRegion').value;
            const provSel = document.getElementById('selProvincia').value;
            const selDist = document.getElementById('selDistrito');

            selDist.innerHTML = '<option value="">-- Seleccione --</option>';

            if (!provSel) {
                selDist.disabled = true;
                return;
            }

            // A. Filtrar distritos de esa provincia
            let distritos = todosLosLugares.filter(l => l.region === regionSel && l.provincia === provSel);

            // B. ORDENAR ALFAB칄TICAMENTE (Por nombre de distrito)
            distritos.sort((a, b) => a.distrito.localeCompare(b.distrito));

            // C. Llenar select
            distritos.forEach(d => {
                const opt = document.createElement('option');
                opt.value = d.distrito; 
                opt.innerText = d.distrito;
                selDist.appendChild(opt);
            });

            selDist.disabled = false;
        }

        // 4. CARGAR DASHBOARD (ORQUESTACI칍N)
        async function cargarDashboard() {
            const distrito = document.getElementById('selDistrito').value;
            if (!distrito) return;

            try {
                const resp = await fetch(`${API_URL}/api/dashboard/${distrito}`);
                const data = await resp.json();

                console.log("Orquestaci칩n completada:", data);

                document.getElementById('kpiTemp').innerText = data.clima.temp_actual + "춿C";
                document.getElementById('kpiViento').innerText = data.clima.viento + " km/h";
                document.getElementById('kpiPob').innerText = data.social.poblacion.toLocaleString();
                
                // Formato condicional para PBI (Verde si es positivo)
                const pbiElem = document.getElementById('kpiPbi');
                pbiElem.innerText = (data.social.pbi >= 0 ? "+" : "") + data.social.pbi + "%";
                pbiElem.style.color = data.social.pbi >= 0 ? "#27ae60" : "#c0392b";

                const {lat, lon} = data.coordenadas;
                map.setView([lat, lon], 13);
                if (marker) map.removeLayer(marker);
                marker = L.marker([lat, lon]).addTo(map)
                    .bindPopup(`<b>${data.lugar}</b><br>Regi칩n: ${data.region}`)
                    .openPopup();

                actualizarGraficos(data);

            } catch (e) {
                console.error("Error en dashboard:", e);
            }
        }

        function actualizarGraficos(data) {
            const ctx1 = document.getElementById('chartClima');
            const ctx2 = document.getElementById('chartRadar');
            const ctx3 = document.getElementById('chartMix');

            if(gClima) gClima.destroy();
            if(gRadar) gRadar.destroy();
            if(gMix) gMix.destroy();

            gClima = new Chart(ctx1, {
                type: 'bar',
                data: {
                    labels: ['M칤n (Noche)', 'Actual', 'M치x (D칤a)'],
                    datasets: [{
                        label: 'Temperatura (춿C)',
                        data: [data.clima.temp_min, data.clima.temp_actual, data.clima.temp_max],
                        backgroundColor: ['#2980b9', '#f39c12', '#c0392b'],
                        borderRadius: 5
                    }]
                },
                options: { responsive: true, maintainAspectRatio: false }
            });

            gRadar = new Chart(ctx2, {
                type: 'radar',
                data: {
                    labels: ['Pobreza', 'D칠ficit Salud', 'Riesgo Clima', 'Densidad Urb.'],
                    datasets: [{
                        label: `칈ndice de Vulnerabilidad - ${data.lugar}`,
                        data: [data.social.pobreza * 10, 10-(data.social.hospitales/3), data.clima.viento/3, 6],
                        backgroundColor: 'rgba(231, 76, 60, 0.2)',
                        borderColor: '#c0392b',
                        pointBackgroundColor: '#c0392b'
                    }]
                },
                options: { 
                    responsive: true, maintainAspectRatio: false,
                    scales: { r: { beginAtZero: true, max: 10 } }
                }
            });

            gMix = new Chart(ctx3, {
                type: 'line',
                data: {
                    labels: ['2020', '2021', '2022', '2023', '2024 (Proy)'],
                    datasets: [{
                        label: 'Evoluci칩n del PBI Regional (%)',
                        data: [data.social.pbi - 2, data.social.pbi - 1, data.social.pbi, data.social.pbi + 0.5, data.social.pbi + 1.2],
                        borderColor: '#27ae60',
                        backgroundColor: 'rgba(39, 174, 96, 0.1)',
                        fill: true,
                        tension: 0.4
                    }]
                },
                options: { responsive: true, maintainAspectRatio: false }
            });
        }

        iniciarSistema();
    </script>
</body>
</html>